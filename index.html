<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mappa 3D con Avatar ‚Äì Fix & Polish</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <!-- THREE.js (versione compatibile con Threebox 2.2.x) -->
  <script src="https://unpkg.com/three@0.122.0/build/three.min.js"></script>

  <!-- Threebox -->
  <link href="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/gh/jscastro76/threebox@v.2.2.2/dist/threebox.min.js"></script>

  <style>
    :root {
      --panel-bg: rgba(255,255,255,.9);
      --shadow: 0 2px 6px rgba(0,0,0,.2);
      --radius: 12px;
      --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      
      /* Dimensioni responsive */
      --button-size: clamp(36px, 5vw, 44px);
      --font-size-small: clamp(11px, 2vw, 12px);
      --font-size-normal: clamp(13px, 2.5vw, 14px);
      --padding-small: clamp(6px, 1.5vw, 8px);
      --padding-normal: clamp(8px, 2vw, 12px);
      --gap-small: clamp(8px, 1.5vw, 10px);
      --gap-normal: clamp(10px, 2vw, 15px);
    }
    
    *{box-sizing:border-box}
    body { margin: 0; font-family: var(--font); }
    #map { position: absolute; inset: 0; }

    .avatar-marker {
      background-image: url('https://cdn-icons-png.flaticon.com/512/149/149071.png');
      background-size: cover;
      width: clamp(30px, 5vw, 40px);
      height: clamp(30px, 5vw, 40px);
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: var(--shadow);
    }

    /* Media query per schermi piccoli */
    @media (max-width: 768px) {
      .custom-controls {
        bottom: 10px !important;
        right: 10px !important;
        flex-direction: column !important;
        padding: var(--padding-small) !important;
      }
      
      .custom-controls button {
        font-size: 16px !important;
        padding: 6px !important;
        width: var(--button-size);
        height: var(--button-size);
      }
      
      .pitch-slider {
        width: 60px !important;
        height: 30px !important;
      }
      
      .top-right-controls {
        top: 10px !important;
        right: 10px !important;
        flex-direction: column !important;
        align-items: flex-end !important;
      }
      
      .direction-indicator {
        font-size: var(--font-size-small) !important;
        padding: var(--padding-small) !important;
        max-width: 150px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }
      
      .status-indicator {
        top: 60px !important;
        right: 10px !important;
        max-width: 200px !important;
        font-size: var(--font-size-small) !important;
      }
      
      .debug-info {
        bottom: 70px !important;
        left: 10px !important;
        max-width: 250px !important;
        font-size: 10px !important;
      }
      
      .gps-controls {
        gap: var(--gap-small) !important;
      }
    }

    .custom-controls {
      position: absolute; 
      bottom: 20px; 
      right: 50px;
      display: flex; 
      gap: var(--gap-small); 
      align-items: center;
      background: var(--panel-bg);
      padding: var(--padding-small); 
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      z-index: 1000;
    }
    
    .custom-controls button {
      font-size: clamp(16px, 3vw, 18px); 
      padding: 4px 10px; 
      border: none;
      background: white; 
      border-radius: 8px; 
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .custom-controls button:hover {
      background: #f0f0f0;
    }
    
    .pitch-slider { 
      width: clamp(40px, 8vw, 60px); 
    }

    .top-right-controls {
      position: absolute; 
      top: 20px; 
      right: 20px;
      display: flex; 
      gap: var(--gap-small); 
      align-items: center; 
      z-index: 1000;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    
    .direction-indicator {
      background: rgba(0,0,0,.7); 
      color: #fff;
      padding: var(--padding-small) var(--padding-normal); 
      border-radius: 20px; 
      font-size: var(--font-size-normal); 
      font-weight: 600;
      backdrop-filter: blur(8px);
    }
    
    .home-button, .avatar-toggle {
      background: white; 
      border: none; 
      padding: var(--padding-small) var(--padding-normal); 
      font-size: var(--font-size-normal);
      border-radius: 10px; 
      box-shadow: var(--shadow); 
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .home-button:hover, .avatar-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,.25);
    }

    .status-indicator {
      position: absolute; 
      top: 70px; 
      right: 20px;
      background: rgba(0,0,0,.85); 
      color:#fff; 
      padding: var(--padding-normal); 
      border-radius: 10px;
      font-size: var(--font-size-small); 
      z-index: 1000; 
      max-width: 260px;
    }

    .gps-controls {
      position: absolute; 
      top: 20px; 
      left: 20px; 
      display: flex; 
      flex-direction: column; 
      gap: var(--gap-small); 
      z-index: 1000;
    }
    
    .gps-button, .visibility-button { 
      background: var(--panel-bg); 
      border: none; 
      padding: var(--padding-small) var(--padding-normal); 
      border-radius: 10px; 
      cursor: pointer; 
      box-shadow: var(--shadow);
      font-size: var(--font-size-normal);
      transition: all 0.2s;
    }
    
    .gps-button:hover, .visibility-button:hover {
      transform: translateX(2px);
    }
    
    .gps-button.active { 
      background: #4CAF50; 
      color: #fff; 
    }
    
    .visibility-button.hidden { 
      background: #ff9800; 
      color: #fff; 
    }

    .debug-info {
      position: absolute; 
      bottom: 20px; 
      left: 20px; 
      background: rgba(0,0,0,.85);
      color: #fff; 
      padding: var(--padding-normal); 
      border-radius: 10px; 
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: var(--font-size-small); 
      max-width: 320px; 
      z-index: 1000; 
      white-space: pre-line;
    }
    
    /* Classe per nascondere avatar/marker */
    .avatar-hidden {
      display: none !important;
      visibility: hidden !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="status-indicator" id="statusIndicator">Caricamento‚Ä¶</div>

  <div class="gps-controls">
    <button class="gps-button active" id="gpsToggle">üìç GPS ON</button>
    <button class="visibility-button" id="visibilityToggle">üëÅÔ∏è Mostra</button>
  </div>

  <div class="top-right-controls">
    <button class="avatar-toggle" id="avatarToggle">üë§ 3D</button>
    <button class="home-button" id="goHome">üè†</button>
    <div class="direction-indicator" id="directionIndicator">N 0¬∞</div>
  </div>

  <div class="debug-info" id="debugInfo">Debug GPS: Caricamento‚Ä¶</div>

  <div class="custom-controls">
    <button id="zoomIn">+</button>
    <button id="zoomOut">‚àí</button>
    <input type="range" id="pitchSlider" min="0" max="85" value="60" class="pitch-slider">
  </div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibWVldGdvLWJ1aWxkMDAiLCJhIjoiY21jcTFzdXV2MGQ0MzJscXc0MHc0Y2Q0ZSJ9.hFWnqVLwck_EoyBZGoxdxA';

    // === DEBUG BASE ===
    console.log('=== DEBUG GPS INFO ===');
    console.log('GPS disponibile:', !!navigator.geolocation);
    console.log('HTTPS:', location.protocol === 'https:');
    console.log('User Agent:', navigator.userAgent);

    const statusIndicator = document.getElementById('statusIndicator');
    const debugDiv = document.getElementById('debugInfo');
    const avatarToggle = document.getElementById('avatarToggle');
    const visibilityToggle = document.getElementById('visibilityToggle');
    const DEFAULT_HOME = [0, 0];

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v11',
      zoom: 18, pitch: 60, bearing: 0, center: [0,0], antialias: true
    });

    // Controlli zoom custom
    document.getElementById('zoomIn').onclick = () => map.zoomIn();
    document.getElementById('zoomOut').onclick = () => map.zoomOut();
    document.getElementById('pitchSlider').addEventListener('input', (e) => map.setPitch(parseInt(e.target.value,10)));

    // NavigationControl (solo bussola)
    map.addControl(new mapboxgl.NavigationControl({ showCompass: true, showZoom: false }), 'bottom-right');

    let tb, avatarModel, mixer, currentAnimation = null;
    let use3DAvatar = false;
    let avatarVisible = true; // Nuovo stato per visibilit√†

    let currentLocation = [0,0];
    let previousLocation = [0,0];
    let smoothedLocation = [0,0];
    let avatarMarker;
    let gpsTrackingActive = false;
    let movementTimeout;

    const EMA_ALPHA = 0.25;
    
    window.__lastMoveSpeedKmh = 0;

    function updateDebugInfo(extra) {
      const info = [
        `GPS: ${!!navigator.geolocation ? '‚úÖ' : '‚ùå'}`,
        `HTTPS: ${location.protocol === 'https:' ? '‚úÖ' : '‚ùå'}`,
        `Tracking: ${gpsTrackingActive ? 'üü¢ ON' : 'üî¥ OFF'}`,
        `Avatar: ${avatarVisible ? 'üëÅÔ∏è Visibile' : 'üö´ Nascosto'}`,
        /*`Posizione: ${smoothedLocation[0].toFixed(6)}, ${smoothedLocation[1].toFixed(6)}`,*/
        `Posizione: ${smoothedLocation ? smoothedLocation[0].toFixed(6)+", "+smoothedLocation[1].toFixed(6) : "N/A"}`,
        `Device: ${/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent) ? 'üì±' : 'üíª'}`,
        extra ? `Note: ${extra}` : ''
      ].filter(Boolean);
      debugDiv.textContent = info.join('\n');
    }

    // Permessi
    navigator.permissions.query({ name: 'geolocation' }).then((res) => {
        console.log('Permesso geolocalizzazione:', res.state);

        const onOk = (pos) => {
            const lng = pos.coords.longitude, lat = pos.coords.latitude;
            currentLocation = [lng,lat];
            previousLocation = [lng,lat];
            smoothedLocation = [lng,lat];
            map.flyTo({ center: currentLocation, zoom: 18, pitch: 60, duration: 1600 });
            createAvatarMarker();
            resumeGPSTracking();
            updateDirectionIndicator();
            enableCompassHeading();
            updateDebugInfo();
        };

        const onErr = (err) => {
            console.warn('Errore geolocalizzazione iniziale:', err);
            statusIndicator.textContent = 'Errore GPS ‚Äì uso posizione di fallback (Milano)';
            currentLocation = [9.1900, 45.4642];
            previousLocation = [...currentLocation];
            smoothedLocation = [...currentLocation];
            map.flyTo({ center: currentLocation, zoom: 18, pitch: 60, duration: 1200 });
            createAvatarMarker();
            resumeGPSTracking();
            updateDirectionIndicator();
            enableCompassHeading();
            updateDebugInfo('Fallback: Milano');
        };

        // üëá sempre tenta di ottenere la posizione
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(onOk, onErr, { enableHighAccuracy: true, timeout: 8000 });
        } else {
            onErr(new Error('Geolocalizzazione non supportata'));
        }
    });

    // Marker 2D
    function createAvatarMarker() {
      const el = document.createElement('div');
      el.className = 'avatar-marker';
      if (!avatarVisible) el.classList.add('avatar-hidden');
      avatarMarker = new mapboxgl.Marker(el).setLngLat(smoothedLocation).addTo(map);
    }

    // Threebox layer
    function initializeThreebox() {
      tb = new Threebox(map, map.getCanvas().getContext('webgl'), { defaultLights: true });

      map.addLayer({
        id: 'custom-threebox-model',
        type: 'custom',
        renderingMode: '3d',
        onAdd: function() {
          statusIndicator.textContent = 'Caricamento avatar‚Ä¶';

          const avatarOptions = {
            obj: 'https://models.readyplayer.me/688490fba5d9e1a75b930b7a.glb',
            type: 'gltf',
            scale: { x: 20, y: 20, z: 20 },
            units: 'meters',
            rotation: { x: 90, y: 180, z: 0 },
            anchor: 'bottom-left'
          };

          tb.loadObj(avatarOptions, (model) => {
            avatarModel = model;

            if (model.animations && model.animations.length) {
              mixer = new THREE.AnimationMixer(model);
              const idleNames = ['idle','breathing_idle','standing_idle','default'];
              const byName = {};
              model.animations.forEach(clip => byName[clip.name.toLowerCase()] = clip);
              for (const n of idleNames) {
                if (byName[n]) { 
                  currentAnimation = mixer.clipAction(byName[n]); 
                  currentAnimation.play(); 
                  break; 
                }
              }
              if (!currentAnimation) { 
                currentAnimation = mixer.clipAction(model.animations[0]); 
                currentAnimation.play(); 
              }
            }

            avatarModel.setCoords([smoothedLocation[0], smoothedLocation[1], 2]);
            if (!avatarVisible) avatarModel.visible = false;
            tb.add(avatarModel);

            statusIndicator.textContent = 'Avatar pronto!';
            setTimeout(() => statusIndicator.style.display = 'none', 2000);
          });
        },
        render: function(gl, matrix) {
          tb.update();
          if (mixer) mixer.update(1/60);
        }
      });
    }

    // Toggle Visibilit√† Avatar
    visibilityToggle.addEventListener('click', () => {
      avatarVisible = !avatarVisible;
      
      if (avatarVisible) {
        visibilityToggle.textContent = 'üëÅÔ∏è Mostra';
        visibilityToggle.classList.remove('hidden');
        
        if (use3DAvatar && avatarModel) {
          avatarModel.visible = true;
        } else if (avatarMarker) {
          avatarMarker.getElement().classList.remove('avatar-hidden');
        }
        
        statusIndicator.style.display = 'block';
        statusIndicator.textContent = 'Avatar visibile';
      } else {
        visibilityToggle.textContent = 'üö´ Nascondi';
        visibilityToggle.classList.add('hidden');
        
        if (use3DAvatar && avatarModel) {
          avatarModel.visible = false;
        } else if (avatarMarker) {
          avatarMarker.getElement().classList.add('avatar-hidden');
        }
        
        statusIndicator.style.display = 'block';
        statusIndicator.textContent = 'Avatar nascosto';
      }
      
      /*setTimeout(() => statusIndicator.style.display = 'none', 1500);*/
      updateDebugInfo();
    });

    // Toggle 2D/3D
    avatarToggle.addEventListener('click', () => {
      if (!use3DAvatar) {
        statusIndicator.style.display = 'block';
        statusIndicator.textContent = 'Attivo avatar 3D‚Ä¶';
        if (avatarMarker) { avatarMarker.remove(); avatarMarker = null; }
        if (map.getLayer('custom-threebox-model')) {
          map.setLayoutProperty('custom-threebox-model','visibility','visible');
          if (avatarModel) {
            avatarModel.setCoords([smoothedLocation[0], smoothedLocation[1], 2]);
            if (avatarVisible) avatarModel.visible = true;
          }
          statusIndicator.textContent = 'Avatar 3D attivo!';
          setTimeout(() => statusIndicator.style.display = 'none', 1500);
        } else {
          initializeThreebox();
        }
        use3DAvatar = true;
        avatarToggle.textContent = 'üë§ 2D';
        avatarToggle.style.background = '#4CAF50';
        avatarToggle.style.color = '#fff';
      } else {
        if (map.getLayer('custom-threebox-model')) {
          map.setLayoutProperty('custom-threebox-model','visibility','none');
        }
        createAvatarMarker();
        use3DAvatar = false;
        avatarToggle.textContent = 'üë§ 3D';
        avatarToggle.style.background = 'white';
        avatarToggle.style.color = 'black';
        statusIndicator.style.display = 'block';
        statusIndicator.textContent = 'Avatar 2D attivo';
        setTimeout(() => statusIndicator.style.display = 'none', 1500);
      }
    });

    // Bearing geografico
    function geographicBearing(from, to){
      const [lon1, lat1] = from.map(v => v * Math.PI/180);
      const [lon2, lat2] = to.map(v => v * Math.PI/180);
      const dLon = lon2 - lon1;
      const y = Math.sin(dLon) * Math.cos(lat2);
      const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
      let brng = Math.atan2(y, x) * 180/Math.PI;
      return (brng + 360) % 360;
    }

    function calculateDistance(a,b){
      const R=6371e3;
      const [lon1,lat1]=a.map(v=>v*Math.PI/180);
      const [lon2,lat2]=b.map(v=>v*Math.PI/180);
      const dLat=lat2-lat1, dLon=lon2-lon1;
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    function lerp(a,b,t){ return a + (b-a)*t; }

    function smoothTo(target){
      smoothedLocation = [
        lerp(smoothedLocation[0], target[0], EMA_ALPHA),
        lerp(smoothedLocation[1], target[1], EMA_ALPHA)
      ];
    }

    function updateMovementUI(distance, bearing){
        const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
        const idx = Math.round(bearing/22.5)%16;
        const direction = dirs[idx];

        const now = performance.now();
        if (!window.__lastMoveTime) { window.__lastMoveTime = now; window.__lastMoveDist = 0; }
        const dt = Math.max(1, (now - window.__lastMoveTime)/1000);
        const speed = distance/dt;
        const kmh = speed*3.6;

        window.__lastMoveSpeedKmh = kmh;

        const dirEl = document.getElementById('directionIndicator');
        // Versione abbreviata per mobile
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          dirEl.textContent = `${direction} ${Math.round(bearing)}¬∞`;
        } else {
          dirEl.textContent = `${direction} ${Math.round(bearing)}¬∞ ‚Ä¢ ${kmh.toFixed(1)} km/h`;
        }
        window.__lastMoveTime = now;
    }

    function startWalkingAnimation(){
      if (!avatarModel || !mixer) return;
      const names = ['walking','walk','run','running','locomotion'];
      for (const clip of (avatarModel.animations||[])){
        const n = clip.name.toLowerCase();
        if (names.some(s => n.includes(s))){
          if (currentAnimation) currentAnimation.fadeOut(0.25);
          currentAnimation = mixer.clipAction(clip);
          currentAnimation.reset().fadeIn(0.25).play();
          return;
        }
      }
    }

    function startIdleAnimation(){
      if (!avatarModel || !mixer) return;
      const names = ['idle','breathing_idle','standing_idle','default'];
      for (const clip of (avatarModel.animations||[])){
        const n = clip.name.toLowerCase();
        if (names.some(s => n.includes(s))){
          if (currentAnimation) currentAnimation.fadeOut(0.25);
          currentAnimation = mixer.clipAction(clip);
          currentAnimation.reset().fadeIn(0.25).play();
          return;
        }
      }
      if ((avatarModel.animations||[]).length){
        if (currentAnimation) currentAnimation.fadeOut(0.25);
        currentAnimation = mixer.clipAction(avatarModel.animations[0]);
        currentAnimation.reset().fadeIn(0.25).play();
      }
    }

    function applyAvatarTransform(newLoc){
      smoothTo(newLoc);
      const distance = calculateDistance(currentLocation, newLoc);
      const bearing = geographicBearing(previousLocation, newLoc);

      if (use3DAvatar && avatarModel){
        avatarModel.setCoords([smoothedLocation[0], smoothedLocation[1], 1.8]);
        
        // FIX 1: Rotazione solo sull'asse Y (yaw), mantieni X fisso a 90
        const yDeg = -(bearing - 90);
        avatarModel.setRotation({ x: 0, y: yDeg, z: 0 }); // X sempre a 90!

        if (mixer && distance > 1.5){
          clearTimeout(movementTimeout);
          startWalkingAnimation();
          movementTimeout = setTimeout(() => startIdleAnimation(), 1600);
        }
      } else if (avatarMarker){
        avatarMarker.setLngLat(smoothedLocation);
      }

      updateMovementUI(distance, bearing);
      previousLocation = currentLocation;
      currentLocation = newLoc;
    }

    // Bussola dispositivo (quando fermo)
    function enableCompassHeading(){
      function onHeading(heading){
        if (use3DAvatar && avatarModel && typeof heading === 'number'){
          // FIX: Mantieni X a 90
          const yDeg = -(heading - 90);
          avatarModel.setRotation({ x: 90, y: yDeg, z: 0 }); // X sempre a 90!
        }
      }

      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function'){
        avatarToggle.addEventListener('click', async () => {
          try {
            const res = await DeviceOrientationEvent.requestPermission();
            if (res === 'granted') {
              window.addEventListener('deviceorientation', (e) => onHeading(e.webkitCompassHeading ?? (360 - e.alpha)));
            }
          } catch(err){ console.warn('DeviceOrientation permesso negato', err); }
        }, { once: true });
      } else if (window.DeviceOrientationEvent){
        window.addEventListener('deviceorientationabsolute' in window ? 'deviceorientationabsolute' : 'deviceorientation', (e) => {
          const h = e.absolute && typeof e.alpha === 'number' ? (360 - e.alpha) : undefined;
          if (h !== undefined) onHeading(h);
        });
      }
    }

    // GPS
    const gpsToggleBtn = document.getElementById('gpsToggle');
    gpsToggleBtn.addEventListener('click', () => {
      if (gpsTrackingActive) stopGPSTracking(); else resumeGPSTracking();
    });

    function stopGPSTracking(){
      if (window.__gpsWatchId){
        navigator.geolocation.clearWatch(window.__gpsWatchId);
        window.__gpsWatchId = null;
      }
      gpsTrackingActive = false;  
      // reset variabili posizione
      currentLocation = null;
      previousLocation = null;
      smoothedLocation = null;
      
      statusIndicator.textContent = 'GPS tracking fermo';
      gpsToggleBtn.classList.remove('active');
      gpsToggleBtn.textContent = 'üìç GPS OFF';
      updateDebugInfo();
    }


/*     function resumeGPSTracking(){
      if (!window.__gpsWatchId) startGPSTracking();
    } */

    function resumeGPSTracking(){
        if (navigator.geolocation){
            gpsTrackingActive = true;
            gpsToggleBtn.classList.add('active');
            gpsToggleBtn.textContent = 'üìç GPS ON';
            statusIndicator.textContent = 'GPS tracking attivo';
            
            // üî• prendo subito la posizione iniziale
            navigator.geolocation.getCurrentPosition((pos) => {
            const lng = pos.coords.longitude;
            const lat = pos.coords.latitude;
            currentLocation = [lng, lat];
            previousLocation = [lng, lat];
            smoothedLocation = [lng, lat];

            map.flyTo({ center: currentLocation, zoom: 18, pitch: 60, duration: 1600 });

            if (!avatarMarker && !avatarModel) {
                createAvatarMarker();
            }

            updateDirectionIndicator();
            enableCompassHeading();
            updateDebugInfo();
            });

            // poi attivo il tracking continuo
            window.__gpsWatchId = navigator.geolocation.watchPosition(
            handleGPS, 
            (err) => console.error('Errore GPS:', err),
            { enableHighAccuracy: true, maximumAge: 1000, timeout: 8000 }
            );
        }
    }

    function startGPSTracking(){
      if (!navigator.geolocation){
        statusIndicator.textContent = 'GPS non supportato dal browser';
        updateDebugInfo(); return;
      }
      statusIndicator.textContent = 'Tracking GPS attivo';
      gpsTrackingActive = true;
      gpsToggleBtn.classList.add('active');
      gpsToggleBtn.textContent = 'üìç GPS ON';

      const opts = { enableHighAccuracy: true, maximumAge: 1000, timeout: 8000 };
      window.__gpsWatchId = navigator.geolocation.watchPosition((pos) => {
        const { longitude: lng, latitude: lat, accuracy, speed, heading } = pos.coords;
        const newLoc = [lng, lat];
        if (accuracy && accuracy > 100) { updateDebugInfo('Ignoro fix >100m'); return; }

        // GPS heading quando in movimento
        if (typeof heading === 'number' && !Number.isNaN(heading) && use3DAvatar && avatarModel){
          const yDeg = -(heading - 90);
          avatarModel.setRotation({ x: 90, y: yDeg, z: 0 }); // X sempre a 90!
        }

        const d = calculateDistance(smoothedLocation, newLoc);
        if (d > 1) applyAvatarTransform(newLoc);
        if (d > 50) map.easeTo({ center: newLoc, duration: 1000 });
        updateDebugInfo(speed ? `Vel: ${(speed*3.6).toFixed(1)} km/h` : undefined);
      }, (err) => {
        statusIndicator.textContent = `Errore GPS: ${err.message}`;
        updateDebugInfo('Errore GPS');
      }, opts);
    }

    // Pulsante Home
    document.getElementById('goHome').addEventListener('click', () => {  
        if (gpsTrackingActive) {
            map.flyTo({ center: smoothedLocation, zoom: 18, pitch: 60, speed: .8 });
        } else {
        // Quando GPS OFF vai al default
            map.flyTo({ center: DEFAULT_HOME, zoom: 12, pitch: 45, speed: .8 });
        }
    });

    // Indicatore direzione MAPPA
    const directionIndicator = document.getElementById('directionIndicator');
    function updateDirectionIndicator(){
        const b = ((map.getBearing()%360)+360)%360;
        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
        const idx = Math.round(b/45)%8;
        const isMobile = window.innerWidth <= 768;
        const kmh = window.__lastMoveSpeedKmh && !isMobile ? ` ‚Ä¢ ${window.__lastMoveSpeedKmh.toFixed(1)} km/h` : '';
        directionIndicator.textContent = `${dirs[idx]} ${Math.round(b)}¬∞${kmh}`;
    }
    map.on('rotate', updateDirectionIndicator);
    window.addEventListener('resize', updateDirectionIndicator);

    // Caricamento iniziale
    map.on('load', () => {
      console.log('Mappa caricata');

      // Edifici 3D
      map.addLayer({
        id: '3d-buildings', source: 'composite', 'source-layer': 'building',
        filter: ['==','extrude','true'], type: 'fill-extrusion', minzoom: 15,
        paint: {
          'fill-extrusion-color': '#aaa',
          'fill-extrusion-height': ['get','height'],
          'fill-extrusion-base': ['get','min_height'],
          'fill-extrusion-opacity': 0.6
        }
      });

      statusIndicator.textContent = 'Ottenendo posizione GPS‚Ä¶';
    });

    // Aggiorna debug periodico
    setInterval(() => updateDebugInfo(), 5000);
  </script>
</body>
</html>
